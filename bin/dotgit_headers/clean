#! /bin/bash

function clean_home_fast
{
	for f in "${FN[@]}"; do
		if [ -a "$HOME/$f" ] || [ -h "$HOME/$f" ]; then
			# Do not delete symlinks that do not point to repo
			if [ -a "$HOME/$f" ] && [ -h "$HOME/$f" ] && \
				[[ ! $(readlink -f "$HOME/$f") =~ ^$REPO ]]; then
				continue
			fi

			verecho "Removing \"$f\""
			rm "$HOME/$f"
		fi
	done
}

function clean_repo
{
	verecho "\nInitiating repo cleanup"

	verecho "Cleaning dotfiles folder"
	clean_repo_folder "$DG_DFDIR"
	verecho "Cleaning dmz folder"
	clean_repo_folder "$DG_DMZ"
}

function clean_repo_folder
{
	if ! cd "$REPO/$1"; then
		echo "Unable to enter $1 directory"
		exit 1
	fi

	IFS=$'\n'
	while read -r fl; do
		[ ! "$fl" ] && break

		local c=${fl%%/*}
		local f=${fl#*/}
		f=${f%\.hash}

		local found=0

		local index=0
		for fns in "${FN[@]}"; do
			if [[ $fns == "$f" ]]; then
				IFS=$','
				for cts in ${FC[$index]}; do
					if [[ $cts == "$c" ]]; then
						found=1;
						break;
					fi
				done
				unset cts

				[[ $found -eq 1 ]] && break
			fi

			index=$((index + 1))
		done
		unset fns

		if [[ $found -ne 1 ]]; then
			verecho "$(levecho 1 "Removing $fl")"
			rm "$fl"
		fi

	done <<< "$(find . -not -type d | cut -c 3-)"
	unset fl

	verecho "$(levecho 1 "Removing empty directories")"
	find . -type d -empty -delete
}

[[ ! $DG_START ]] && echo "Do not source this directly, it is used by dotgit"
