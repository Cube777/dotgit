#! /bin/bash

# Part of dotgit

NORMFILES=()
CRYPTFILES=()
DIRFILES=()
CDIRFILES=()

function addnormfiles
{
	dir=$1
	loc=$2
	suf=$3

	if [ ! -d "$loc/$dir" ]; then return; fi

	if [ "$suf" != "$dir" ]; then
		suf=$(echo -n ":$suf")
	else
		suf=""
	fi

	for k in $(find -L "$loc/$dir" -not -type d | \
		cut -c `expr ${#loc} + 2`-); do

		if [ -z "$NORMFILES" ]; then
			t=""
		else
			t="\n"
		fi

		NORMFILES=(${NORMFILES[@]} "$k$suf")
	done;
}

function addcryptfiles
{
	dir=$1
	loc=$2
	suf=$3

	if [ ! -d "$loc/$dir" ]; then return; fi

	if [ "$suf" != "$dir" ]; then
		suf=$(echo -n ":$suf")
	else
		suf=""
	fi

	for k in $(find -L "$loc/$dir" -not -type d -and -not -name '*.hash'| \
		cut -c `expr ${#loc} + 2`-); do

		if [ -z "$CRYPTFILES" ]; then
			t=""
		else
			t="\n"
		fi

		CRYPTFILES=(${CRYPTFILES[@]} "$k$suf")
	done;
}

function cfilelist
{
	DOTFILES="$REPO/dotfiles"
	DMZ="$REPO/dmz"

	while read p; do
		if ! [[ $p =~ ^$ ]] && ! [[ $p =~ ^# ]]; then
			NORMFILES=( ${NORMFILES[@]} "$p" )
		fi
	done < "$REPO/filelist"

	while read p; do
		if ! [[ $p =~ ^$ ]] && ! [[ $p =~ ^# ]]; then
			CRYPTFILES=( ${CRYPTFILES[@]} "$p" )
		fi
	done < "$REPO/cryptlist"

	while read p; do
		if ! [[ $p =~ ^$ ]] && ! [[ $p =~ ^# ]]; then
			DIRFILES=( ${DIRFILES[@]} "$p" )
		fi
	done < "$REPO/dir_filelist"

	while read p; do
		if ! [[ $p =~ ^$ ]] && ! [[ $p =~ ^# ]]; then
			CDIRFILES=( ${CDIRFILES[@]} "$p" )
		fi
	done < "$REPO/dir_cryptlist"

	loc=1

	case "$1" in
		"restore")loc=0;;
		"generate")loc=0;;
		"hard-restore")loc=0;;
		"decrypt")loc=0;;
		"passwd")loc=0;;
	esac;

	if [ $loc == 1 ]; then
		for i in ${DIRFILES[@]}; do
			dir=$(echo $i | sed 's/:.*//')
			suf=$(echo $i | rev | sed 's/:.*//' | rev)
			addnormfiles "$dir" "$HOME" "$suf"
		done

		for i in ${CDIRFILES[@]}; do
			dir=$(echo $i | sed 's/:.*//')
			suf=$(echo $i | rev | sed 's/:.*//' | rev)
			addcryptfiles "$dir" "$HOME" "$suf"
		done
	else
		for i in ${DIRFILES[@]}; do
			dir=$(echo $i | sed 's/:.*//')
			suf=$(echo $i | rev | sed 's/:.*//' | rev)

			if [[ $i =~ : ]]; then
				if [ -z "$2" ]; then
					addnormfiles "$i" "$DOTFILES/$HOSTNAME" "$suf"
				else
					addnormfiles "$i" "$DOTFILES/$2" "$suf"
				fi
			else
				if [ -z "$2" ]; then
					addnormfiles "$i" "$DOTFILES/common" "$suf"
				fi
			fi
		done

		for i in ${CRYPTFILES[@]}; do
			dir=$(echo $i | sed 's/:.*//')
			suf=$(echo $i | rev | sed 's/:.*//' | rev)

			if [[ $i =~ : ]]; then
				if [ -z "$2" ]; then
					addcryptfiles "$i" "$DMZ/$HOSTNAME" "$suf"
				else
					addcryptfiles "$i" "$DMZ/$2" "$suf"
				fi
			else
				if [ -z "$2" ]; then
					addcryptfiles "$i" "$DMZ/common" "$suf"
				fi
			fi
		done
	fi
}

