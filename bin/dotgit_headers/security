#! /bin/bash

function encrypt
{
	cd "$DMZ"
	for i in $(find -type l); do
		if [ -f "$DOTFILES/$i" ]; then
			rm "$DOTFILES/$i"
		fi
		cp -P --parents "$i" "$DOTFILES"
	done

	for i in $(find -not -type d -and -not -type l); do
		mkdir -p $(dirname "$DOTFILES/$i")
		if [ -f "$DOTFILES/$i" ]; then
			sum=$(sha256sum "$i" | sed 's/\ .*//')
			compare=""
			if [ -f "$DOTFILES/$i.hash" ]; then
				compare=$(cat "$DOTFILES/$i.hash")
			fi
			if [ "$sum" == "$compare" ]; then
				continue;
			fi
			rm "$DOTFILES/$i"
		fi
		if [ -z "$PASSWD" ]; then pprompt "encryption"; fi
		echo "-->Encrypting $(echo $i | cut -c 3-)"
		gpg -c --batch --passphrase-file "$REPO/tmp" -o "$DOTFILES/$i" "$i"
		chmod $(stat -c '%a' "$i") "$DOTFILES/$i"
		sha256sum "$i" | sed 's/\ .*//' > "$DOTFILES/$i.hash"
	done
}

function decrypt
{
	for i in ${CRYPTFILES[@]}; do
		if echo $i | grep -qv ":"; then i=$(echo "$i:common"); fi

		ownrs=($(echo $i | rev | sed s/\:.*// | sed s/\,/\ /g | rev))
		ownrs=($(for z in ${ownrs[@]}; do echo $z; done | sort))
		filename=$(echo $i | sed s/\:.*//);

		for k in `seq 0 $(expr ${#ownrs[@]} - 1)`; do

			if [ ! -f "$DOTFILES/${ownrs[$k]}/$filename"  ]; then
				echo "--> File ${ownrs[$k]}/$filename does not yet exist in the"\
					"repo. Please run update/encrypt to populate repository"
				continue
			fi

			mkdir -p "$(dirname "$DMZ/${ownrs[$k]}/$filename")"

			copy=0
			if [ -f "$DMZ/${ownrs[$k]}/$filename" ]; then
				if [ -h "$DMZ/${ownrs[$k]}/$filename" ]; then
					copy=1
				else
					sum=$(sha256sum "$DMZ/${ownrs[$k]}/$filename" | \
						sed 's/\ .*//')
					temp="$DOTFILES/${ownrs[$k]}/$filename"
					if [ -h "$temp" ]; then
						temp=$(readlink "$temp")
					fi
					if [ ! -f "$temp" ]; then
						temp=""
					else
						temp=$(cat "$temp.hash")
					fi

					if [ "$sum" != "$temp" ]; then
						echo -e "Your local version of $filename"\
							"(${ownrs[$k]}) differs from the version in the"\
							"repository\n"

						yesno "Do you want to overwrite the local version?"

						if [ $? == 1 ]; then copy=1; fi
					fi
				fi
			else
				copy=1
			fi

			if [ $copy == 1 ]; then
				if [ -h "$DOTFILES/${ownrs[$k]}/$filename" ]; then
					cd "$DOTFILES"
					cp -P --parents "${ownrs[$k]}/$filename" "$DMZ"
					continue
				fi

				if [ -z "$PASSWD" ]; then pprompt "decryption"; fi

				echo "-->Decrypting $filename"
				gpg --quiet --batch --decrypt --passphrase-file "$REPO/tmp" \
					--output "$REPO/mid" "$DOTFILES/${ownrs[$k]}/$filename"
				chmod $(stat -c '%a' "$DOTFILES/${ownrs[$k]}/$filename") \
					"$REPO/mid"

				if [ -f "$DMZ/${ownrs[$k]}/$filename" ]; then
					rm "$DMZ/${ownrs[$k]}/$filename"
				fi

				mv "$REPO/mid" "$DMZ/${ownrs[$k]}/$filename"
			fi
		done
	done
}

