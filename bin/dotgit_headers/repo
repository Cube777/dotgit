#! /bin/bash
# Part of dotgit

function errecho
{
	>&2 echo "$@"
}

function verecho
{
	[[ $DG_VERBOSE -eq 0 ]] && echo -e "$@"
}

function levecho
{
	local tmp=
	while [[ ${#tmp} -lt "$1" ]]; do
		tmp=$(echo -n "$tmp ")
	done
	tmp=$(echo -n "$tmp>")

	shift
	echo -n "$tmp $*"
}

function prompt
{
	read -rp "$* [Y/n]: " ans

	[[ $ans ==  "Y" ]] && return 0
	[[ $ans ==  "y" ]] && return 0
	[[ ! $ans  ]] && return 0

	return 1
}

function init
{
	if ! cd "$REPO"; then
		errecho "Unable to enter repo."
		exit 1
	fi

	touch "$FILELIST"
	touch "$CRYPTLIST"
	echo "$DG_DMZ" >> .gitignore

	if [ ! -d ".git" ]; then
		git init
		git checkout -b master
		git add --all
		git commit -m "Initial dotgit commit"
	fi
}

function safety_checks
{
	if [[ $REPO == "$HOME" ]]; then
		errecho "Do not run dotgit in your home directory, run it in your" \
			"dotfiles repository"
		exit 1
	fi

	if [ ! -d ".git" ]; then
		errecho "This does not appear to be a git directory. Aborting..."
		exit 1
	fi

	if [ ! -f "$FILELIST" ]; then
		errecho "Cannot locate filelist. Please make sure this repository" \
			"was initialised by dotgit."
		exit 1
	fi

	if [ ! -f "$CRYPTLIST" ]; then
		errecho "Cannot locate cryptlist. Please make sure this repository" \
			"was initialised by dotgit."
		exit 1
	fi

	if ! mkdir -p "$REPO/$DG_DFDIR"; then
		"Unable to create dotfiles dir"
		exit 1
	fi

	if ! mkdir -p "$REPO/$DG_DMZ"; then
		"Unable to create dmz dir"
		exit 1
	fi
}

function init_flists
{
	verecho "Initiating filelists"
	# shellcheck disable=SC2164
	cd "$HOME"
	local n=0

	IFS=$'\n'
	for cur in "$REPO/$FILELIST" "$REPO/$CRYPTLIST"; do
		while read -r line; do
			[ ! "$line" ] && continue
			[[ $line =~ ^# ]] && continue

			local -a l
			IFS=$':' l=($line)

			local -a arr
			IFS=$',' arr=(${l[1]:-"common"})
			IFS=$'\n' arr=($(sort<<<"${arr[*]}"))

			if [ ! -d "${l[0]}" ]; then
				FN+=("${l[0]}")
				IFS=$',' FC+=("${arr[*]}")
				FE+=($n)
				verecho "$(levecho 1 "Added ${l[0]} - ${arr[*]} - $n")"
			else
				verecho "$(levecho 1 \
					"Using directory mode for ${l[0]} - ${arr[*]} - $n")"
				while read -r fls; do
					FN+=("$fls")
					IFS=$',' FC+=("${arr[*]}")
					FE+=($n)
					verecho "$(levecho 2 "Added $fls")"
				done <<< "$(find "${l[0]}" -not -type d)"
				unset fls
			fi
		done < "$cur"
		n=1
	done

	unset line
	unset cur
}

[[ ! $DG_START ]] && echo "Do not source this directly, it is used by dotgit"
